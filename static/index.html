<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Content Moderator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <div class="container mt-5">
    <!-- Navigation Buttons -->
    <div id="welcome-section">
      <h1>Welcome to Smart Content Moderator</h1>
      <p>Select an option below:</p>
      <div class="d-flex gap-3">
        <button class="btn btn-primary" onclick="showSection('text')">Text Moderation</button>
        <button class="btn btn-primary" onclick="showSection('image')">Image Moderation</button>
        <button class="btn btn-primary" onclick="showSection('analytics')">Analytics Summary</button>
      </div>
    </div>

    <!-- Text Moderation Form -->
    <div id="text-section" class="mt-4" style="display:none;">
      <h3>Text Moderation</h3>
      <form id="textForm">
        <div class="mb-3">
          <input type="email" id="text-email" class="form-control" placeholder="Email" required />
        </div>
        <div class="mb-3">
          <textarea id="text-input" class="form-control" rows="4" placeholder="Enter text to moderate" required></textarea>
        </div>
        <button type="submit" class="btn btn-success">Moderate Text</button>
        <button type="button" class="btn btn-secondary" onclick="showSection('welcome')">Back</button>
      </form>
      <div id="text-result" class="mt-3" style="display:none;">
        <h5>Result:</h5>
        <p><strong>Classification:</strong> <span id="text-classification"></span></p>
        <p><strong>Confidence:</strong> <span id="text-confidence"></span></p>
        <p><strong>Reasoning:</strong> <span id="text-reasoning"></span></p>
      </div>
    </div>

    <!-- Image Moderation Form -->
    <div id="image-section" class="mt-4" style="display:none;">
      <h3>Image Moderation</h3>
      <form id="imageForm" enctype="multipart/form-data">
        <div class="mb-3">
          <input type="email" id="image-email" class="form-control" placeholder="Email" required />
        </div>
        <div class="mb-3">
          <input type="file" id="image-file" class="form-control" accept="image/jpeg, image/png" required />
        </div>
        <button type="submit" class="btn btn-success">Moderate Image</button>
        <button type="button" class="btn btn-secondary" onclick="showSection('welcome')">Back</button>
      </form>
      <div id="image-result" class="mt-3" style="display:none;">
        <h5>Result:</h5>
        <p><strong>Classification:</strong> <span id="image-classification"></span></p>
        <p><strong>Confidence:</strong> <span id="image-confidence"></span></p>
        <p><strong>Reasoning:</strong> <span id="image-reasoning"></span></p>
      </div>
    </div>

    <!-- Analytics Summary Form -->
    <div id="analytics-section" class="mt-4" style="display:none;">
      <h3>Analytics Summary</h3>
      <form id="analyticsForm">
        <div class="mb-3">
          <input type="email" id="analytics-email" class="form-control" placeholder="Email" required />
        </div>
        <button type="submit" class="btn btn-success">Get Analytics</button>
        <button type="button" class="btn btn-secondary" onclick="showSection('welcome')">Back</button>
      </form>
      <div id="analytics-result" class="mt-3" style="display:none;">
        <h5>Summary:</h5>
        <p><strong>Email:</strong> <span id="analytics-email-result"></span></p>
        <p><strong>Total Requests:</strong> <span id="analytics-total"></span></p>
        <p><strong>Classifications:</strong></p>
        <ul id="analytics-classifications"></ul>
        <p><strong>Last Request At:</strong> <span id="analytics-last-request"></span></p>
      </div>
    </div>
  </div>

  <script>
    function showSection(section) {
      // Hide all sections
      document.getElementById('welcome-section').style.display = 'none';
      document.getElementById('text-section').style.display = 'none';
      document.getElementById('image-section').style.display = 'none';
      document.getElementById('analytics-section').style.display = 'none';

      // Hide all results
      document.getElementById('text-result').style.display = 'none';
      document.getElementById('image-result').style.display = 'none';
      document.getElementById('analytics-result').style.display = 'none';

      // Show the chosen section
      if(section === 'welcome') {
        document.getElementById('welcome-section').style.display = 'block';
      } else if(section === 'text') {
        document.getElementById('text-section').style.display = 'block';
      } else if(section === 'image') {
        document.getElementById('image-section').style.display = 'block';
      } else if(section === 'analytics') {
        document.getElementById('analytics-section').style.display = 'block';
      }
    }

    // Handle Text Moderation submit
    document.getElementById("textForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const email = document.getElementById("text-email").value;
      const text = document.getElementById("text-input").value;

      const response = await fetch("/api/v1/moderate/text", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, text }),
      });

      if(!response.ok) {
        alert("Failed to moderate text");
        return;
      }

      const data = await response.json();

      document.getElementById("text-classification").innerText = data.classification;
      document.getElementById("text-confidence").innerText = (data.confidence * 100).toFixed(1) + "%";
      document.getElementById("text-reasoning").innerText = data.reasoning;
      document.getElementById("text-result").style.display = "block";
    });

    // Handle Image Moderation submit
    document.getElementById("imageForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const email = document.getElementById("image-email").value;
      const fileInput = document.getElementById("image-file");
      if(fileInput.files.length === 0) {
        alert("Please select an image file");
        return;
      }

      const formData = new FormData();
      formData.append("email", email);
      formData.append("file", fileInput.files[0]);

      const response = await fetch("/api/v1/moderate/image", {
        method: "POST",
        body: formData,
      });

      if(!response.ok) {
        alert("Failed to moderate image");
        return;
      }

      const data = await response.json();

      document.getElementById("image-classification").innerText = data.classification;
      document.getElementById("image-confidence").innerText = (data.confidence * 100).toFixed(1) + "%";
      document.getElementById("image-reasoning").innerText = data.reasoning;
      document.getElementById("image-result").style.display = "block";
    });

    // Handle Analytics Summary submit
    document.getElementById("analyticsForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const email = document.getElementById("analytics-email").value;
      const url = `/api/v1/analytics/summary?user=${encodeURIComponent(email)}`;
      const response = await fetch(url);

      if(!response.ok) {
        alert("Failed to fetch analytics");
        return;
      }

      const data = await response.json();

      document.getElementById("analytics-email-result").innerText = data.email;
      document.getElementById("analytics-total").innerText = data.total_requests;

      const ul = document.getElementById("analytics-classifications");
      ul.innerHTML = "";
      for(const [classification, count] of Object.entries(data.classification_counts)) {
        const li = document.createElement("li");
        li.textContent = `${classification}: ${count}`;
        ul.appendChild(li);
      }

      document.getElementById("analytics-last-request").innerText = new Date(data.last_request_at).toLocaleString();
      document.getElementById("analytics-result").style.display = "block";
    });

    // Initially show welcome section
    showSection('welcome');
  </script>
</body>
</html>
